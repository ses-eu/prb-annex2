::: {.content-hidden}
<!-- This section is hidden and creates all charts and tables before using them in the doc. They need to be ahead of the headings so quarto does not add the heading number to the chart name-->

<!-- # Charts and tables -->
<!-- ## Level1 -->
<!-- ### Traffic L1 -->

```{r chart_level1_traffic_mvt, include=FALSE}
#| file: R/chart_level1_traffic_mvt.R
#| out.width: "100%"
```

```{r chart_level1_traffic_su, include=FALSE}
#| file: R/chart_level1_traffic_su.R
#| out.width: "100%"
```

<!-- ### Safety L1 -->

```{r chart_saf_l1, include=FALSE, options = (doclevel=c("level1"))}
#| file: R/chart_level1_saf.R
#| out.width: "100%"
```

<!-- ## Environment L1 -->

```{r chart_env_kea_l1, options = (doclevel=c("level1")), include=FALSE}
#| file: R/chart_level1_kea.R
#| out.width: "100%"
```

<!-- ## Capacity L1 -->

```{r chart_cap_er, options = (cztype=c("enroute")), include=FALSE}
#| file: R/chart_level1_cap.R
#| out.width: "100%"
```

```{r chart_cap_trm, options = (cztype=c("terminal")), include=FALSE}
#| file: R/chart_level1_cap.R
#| out.width: "100%"
```

<!-- ## Cost-efficiency L1-->

```{r chart_cef_er_1, options = (cz=c("1", "enroute", "level1")), include=FALSE}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_er_2, options = (cz=c("2", "enroute", "level1")), include=FALSE}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_trm_1, options = (cz=c("1", "terminal", "level1")), include=FALSE}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_trm_2, options = (cz=c("2", "terminal", "level1")), include=FALSE}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```


<!-- Level2 text -->
```{r level_2_text}
source(here("R","get_level2_text.R"))
```

:::

```{r fetch-data-state, eval=TRUE}
pp_version <- params$pp_version
acc_no <- params$acc_no
acc_list <- params$acc_list
acc1 <- params$acc1
acc2 <- params$acc2
acc3 <- params$acc3
acc4 <- params$acc4
acc5 <- params$acc5
no_apt_big <- params$no_apt_big
no_apt_small <- params$no_apt_small

nat_curr <- params$nat_curr
xrate2017 <- params$xrate2017
tsu_share <- params$tsu_share
ert_cost_share <- params$ert_cost_share
ert_trm_share <- params$ert_trm_share

main_ansp <- params$main_ansp
other_ansps_str <- params$other_ansps_str
other_met_str <- params$other_met_str

```

```{r yearly_xrates}
# get yearly xrates

xrate <- get_xrates("enroute", ecz_list$ecz_id[1]) |> 
  filter(year == year_report) |> 
  select(pp_exchangerate)

xrate_year_report <- if_else(country == "Luxembourg", 1, pull(xrate))

```


# OVERVIEW

## Contextual information

*`r pp_version`*

```{=latex}

\begin{figure}

\small

\begin{minipage}[t]{0.31\linewidth}
```

**List of ACCs     ** `r acc_no`  
\hspace*{2em} `r acc1` `r ifelse(acc2 != "", "  ", "")`
`r ifelse(acc2 != "", "\\hspace*{2em}", "")` `r acc2` `r ifelse(acc3 != "", "  ", "")`
`r ifelse(acc3 != "", "\\hspace*{2em}", "")` `r acc3` `r ifelse(acc4 != "", "  ", "")`
`r ifelse(acc4 != "", "\\hspace*{2em}", "")` `r acc4` `r ifelse(acc5 != "", "  ", "")`
`r ifelse(acc5 != "", "\\hspace*{2em}", "")` `r paste0(acc5, "  ")` 

\vspace*{1em}
**No of airports in the scope**  
**of the performance plan:**  
\hspace*{2em} • **≥80'K     ** `r no_apt_big`  
\hspace*{2em} • **<80'K     ** `r no_apt_small`

```{=latex}
\end{minipage}%
%
\begin{minipage}[t]{0.38\linewidth}
```

**Exchange rate (1 EUR=)**  
\hspace*{2em} `r paste0("2017: ", xrate2017, " ", nat_curr, "  ")` 
\hspace*{2em} `r paste0(year_report, ": ", xrate_year_report, " ", nat_curr, "  ")`

\vspace*{0.5em}**Share of Union-wide:**  
\hspace*{2em} • **traffic (TSUs) `r year_report`  **  `r paste0(tsu_share, "  ")` 
\hspace*{2em} • **en route costs `r year_report` ** `r paste0(ert_cost_share, "  ")` 
**Share en route / terminal**  
**costs `r year_report`                    ** `r paste0(ert_trm_share, "  ")` 

\vspace*{0.5em}**En route charging zone(s)**
```{r ecz_list_string}
ecz_list_string <- paste0(
  fixed('`\\hspace*{2em}`{=tex}'),
  ecz_list$ecz_name[1],
  if_else(is.na(ecz_list$ecz_name[2]), '' ,  paste0(fixed('` \\\\ \\hspace*{2em}`{=tex}'), ecz_list$ecz_name[2])
          )
)
```
`r paste0(ecz_list_string, "  ")` 

**Terminal charging zone(s)**  
```{r tcz_list_string}
tcz_list_string <- if_else(no_tcz == 0, '`\\hspace*{2em}`{=tex} --',
paste0(
  fixed('`\\hspace*{2em}`{=tex}'),
  tcz_list$tcz_name[1],
  if_else(is.na(tcz_list$tcz_name[2]), '' , paste0(fixed('`\\\\ \\hspace*{2em}`{=tex}'), tcz_list$tcz_name[2])
  )
  ))
```

`r tcz_list_string`

```{=latex}
\end{minipage}%
%
\begin{minipage}[t]{0.31\linewidth}
```

```{r ansp_list_strings}
# this is very convoluted but I couldnt find any other way
other_ansps_list <- str_split(other_ansps_str, "<br/>")[[1]] %>%
  discard(~ .x == "")

other_ansps_str_1 <- reduce(other_ansps_list, ~ paste(.x, .y, sep = fixed('`\\\\`{=tex}\\hspace*{1.2em}')))

other_met_list <- str_split(other_met_str, "<br/>")[[1]] %>%
  discard(~ .x == "")

other_met_str_1 <- reduce(other_met_list, ~ paste(.x, .y, sep = fixed('`\\\\`{=tex}\\hspace*{1.2em}')))

```


**Main ANSP**  
\hspace*{1em} • `r paste0(main_ansp, "  ")`  

\vspace*{1em}**Other ANSPs**
`\begin{flushleft}`{=tex}
\vspace*{-1em}\hspace*{1em} `r paste0(other_ansps_str_1, "  ")` 
`\end{flushleft}`{=tex}

**MET Providers**
`\begin{flushleft}`{=tex}
\vspace*{-1em}\hspace*{1em} `r other_met_str_1`
`\end{flushleft}`{=tex}

```{=latex}
\end{minipage}%

\end{figure}%
```


## Traffic (En route traffic zone)
```{=tex}
\setlength{\fboxrule}{0pt} % Set the border width to 0pt (no border)
\setlength{\fboxsep}{0pt} % Remove padding
```

```{r mvt_conc1}
mvt_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "traffic_IFR", "Table_Findings_traffic_IFR")

mvt_text <- break_l1_text(mvt_conc1) 
mvt_text1 <- mvt_text$text1
mvt_text2 <- mvt_text$text2
```

`r paste0(layout_wrap_figure("chart_level1_traffic_mvt", NULL, mvt_text1, 12), mvt_text2)`

```{r su_conc1}
tsu_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "traffic_SUs", "Table_Findings_traffic_TSU")

tsu_text <- break_l1_text(tsu_conc1) 
tsu_text1 <- tsu_text$text1
tsu_text2 <- tsu_text$text2
```

`r paste0(layout_wrap_figure("chart_level1_traffic_su", NULL, tsu_text1, 12), tsu_text2)`

## Safety (Main ANSP)

```{r saf_conc1}
saf_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "safety", "Table_Findings_safety")

saf_text_conc <- break_l1_text(saf_conc1) 
saf_text1 <- saf_text_conc$text1
saf_text2 <- saf_text_conc$text2
```

`r paste0(layout_wrap_figure("chart_saf_l1", NULL, saf_text1, 13), saf_text2)`


<!-- exception for luxembourg -->
`r if (params$country == "Luxembourg") "::: {.content-hidden}"`

## Environment (Member State)

```{r concl_env}
env_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "environment", "Table_Findings_environment")

env_text <- break_l1_text(env_conc1) 
env_text1 <- env_text$text1
env_text2 <- env_text$text2
```

`r paste0(layout_wrap_figure("chart_env_kea_l1", NULL, env_text1, 12), env_text2)`

`r if (params$country == "Luxembourg") ":::"`

## Capacity (Member State)

```{r concl_cap}
if (params$country == "Luxembourg") {
  cap_er_conc1 <- if_else(params$year == 2023, 
                    get_prb_conclusions("PRB_findings.xlsx", "TRM_capacity", "Table_Findings_TRM_capacity"),
                    "")
  } else {
  cap_er_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "ER_capacity", "Table_Findings_ER_capacity")
  }

cap_text <- break_l1_text(cap_er_conc1) 
cap_text1 <- cap_text$text1
cap_text2 <- cap_text$text2

add_breaks <- fill_l1_text(cap_er_conc1)
```

`r if_else(params$country == "Luxembourg", paste0(layout_wrap_figure("chart_cap_trm", NULL, cap_text1, 12), cap_text2), "")` 

`r if_else (params$no_tcz == 0, paste0(layout_wrap_figure("chart_cap_er", NULL, cap_text1, 12), cap_text2), "")`

`r if_else (params$no_tcz != 0 & params$country != "Luxembourg", layout_wrap_figure("chart_cap_er", "chart_cap_trm", cap_er_conc1, 25, boxsize = 13.5), "")`

## Cost-efficiency (En route/Terminal charging zone(s))

```{r concl-cef}
cef_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "cost-efficiency", "Table_Findings_CEFF")

cef_text <- break_l1_text(cef_conc1) 
cef_text1 <- cef_text$text1
cef_text2 <- cef_text$text2
```

`r if_else (params$no_ecz == 2, layout_wrap_figure("chart_cef_er_1", "chart_cef_er_2", cef_conc1, 38, "chart_cef_trm_1", boxsize = 19.5), "")`

`r if_else (params$no_tcz == 2, layout_wrap_figure("chart_cef_er_1", "chart_cef_trm_1", cef_conc1, 38, "chart_cef_trm_2", boxsize = 19.5), "")`

`r if_else (params$no_ecz == 1 & params$no_tcz == 1, layout_wrap_figure("chart_cef_er_1", "chart_cef_trm_1", cef_conc1, 25, boxsize = 13.5), "")`

`r if_else (params$no_ecz == 1 & params$no_tcz == 0, paste0(layout_wrap_figure("chart_cef_er_1", NULL, cef_text1, 12), cef_text2), "")`

\needspace{3\baselineskip}

# SAFETY
