<!-- ## Safety L2-->

<!-- ### Effectiveness of Safety Management (EoSM) (KPI#1) -->
```{r chart_level1_saf_1, include=FALSE, options = (saf_ansp_index = 1)}
#| file: R/chart_level1_saf.R
#| out.width: "100%"
```

```{r chart_level1_saf_2, eval = (no_saf_ansps > 1), include=FALSE, options = (saf_ansp_index = 2)}
#| file: R/chart_level1_saf.R
#| out.width: "100%"
```

```{r chart_level1_saf_3, eval = (no_saf_ansps > 2), include=FALSE, options = (saf_ansp_index = 3)}
#| file: R/chart_level1_saf.R
#| out.width: "100%"
```

```{r chart_level1_saf_4, eval = (no_saf_ansps > 3), include=FALSE, options = (saf_ansp_index = 4)}
#| file: R/chart_level1_saf.R
#| out.width: "100%"
```

<!-- ### Rate of runway incursions (RIs) (PI#1) -->

```{r chart_saf_ri, include=FALSE}
#| file: R/chart_level2_saf_ri.R
#| out.width: "100%"
```

```{r chart_level2_saf_ri_year_report, eval= (params$country != "MUAC"), options = (safindicator=c("ri")), include=FALSE}
#| file: R/chart_level2_saf_ri_smi_year_report.R
#| out.width: "100%"
```

<!-- ### Rate of separation minima infringements (SMIs) (PI#2) -->

```{r chart_saf_smi, include=FALSE}
#| file: R/chart_level2_saf_smi.R
#| out.width: "100%"
```

```{r chart_level2_saf_smi_year_report, options = (safindicator=c("smi")), include=FALSE}
#| file: R/chart_level2_saf_ri_smi_year_report.R
#| out.width: "100%"
```

<!-- ## Environment L2 -->
<!-- ### En route performance -->
<!-- ##### Horizontal flight efficiency of the actual trajectory (KEA) (KPI#1), of the last filed flight plan (KEP) (PI#1) & shortest constrained route (SCR) (PI#2) -->

```{r chart_env_kea_l2, options = (doclevel=c("level2")), include=FALSE}
#| file: R/chart_level1_kea.R
#| out.width: "100%"
```

```{r chart_env_kea_month, include=FALSE}
#| file: R/chart_level2_kea_month.R
#| out.width: "100%"
```

```{r chart_env_kep_scr, include=FALSE}
#| file: R/chart_level2_kep_scr.R
#| out.width: "100%"
```

```{r chart_env_kep_scr_month, include=FALSE}
#| file: R/chart_level2_kep_scr_month.R
#| out.width: "100%"
```

<!-- ### Terminal performance -->
<!-- #### Additional taxi-out time (AXOT) (PI#3) & Arrival Sequencing and Metering Area (ASMA) time (PI#4) -->

```{r chart_axot_apt, include=FALSE}
#| file: R/chart_level2_env_axot_apt.R
#| out.width: "100%"
```

```{r chart_asma_apt, include=FALSE}
#| file: R/chart_level2_env_asma_apt.R
#| out.width: "100%"
```

<!-- #### Share of arrivals applying continuous descent operations (CDOs) (PI#5) -->
```{r chart_cdo_country, include=FALSE}
#| file: R/chart_level2_env_cdo_country.R
#| out.width: "100%"
```

```{r chart_cdo_apt, include=FALSE}
#| file: R/chart_level2_env_cdo_apt.R
#| out.width: "100%"
```

<!-- ### Civil-Military dimension  -->

```{r chart_cdr, include=FALSE}
#| file: R/chart_level2_env_cdr.R
#| out.width: "100%"
```

```{r chart_rsa, include=FALSE}
#| file: R/chart_level2_env_rsa.R
#| out.width: "100%"
```

<!-- ## Capacity L2-->
<!-- ### En route performance -->
<!-- ### En route ATFM delay (KPI#1) -->
```{r chart_cap_er_l2, options = (cztype=c("enroute")), include=FALSE}
#| file: R/chart_level1_cap.R
#| out.width: "100%"
```

```{r chart_cap_er_month, options = (cztype=c("enroute")), include=FALSE}
#| file: R/chart_level2_cap_month.R
#| out.width: "100%"
```

<!-- #### Other indicators -->
```{r chart_cap_atco, include=FALSE}
#| file: R/chart_level2_cap_atco.R
#| out.width: "100%"
```

```{r chart_cap_atco_acc, include=FALSE}
#| file: R/chart_level2_cap_atco_acc.R
#| out.width: "100%"
```

<!-- ### Terminal performance -->
<!-- #### Arrival ATFM delay (KPI#2) -->
```{r chart_cap_trm_l2, options = (cztype=c("terminal")), eval=(params$no_tcz != 0), include=FALSE}
#| file: R/chart_level1_cap.R
#| out.width: "100%"
```

```{r chart_cap_trm_month, options = (cztype=c("terminal")), eval=(params$no_tcz != 0), include=FALSE}
#| file: R/chart_level2_cap_month.R
#| out.width: "100%"
```

<!-- ## Cost-efficiency  -->
<!-- ### ECZ 1 -->
<!-- #### Unit cost (KPI#1) -->

```{r cz_def_ez1}
cztype <- "enroute"
czindex <- 1
no_cz <- params$no_ecz
```

```{r chart_cef_duc_l2_enroute1, options = (cz=c(czindex, cztype,"level2")), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_su_l2_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_su.R
#| out.width: "100%"
```



```{r chart_cef_cost_entity_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_entity.R
#| out.width: "100%"
```

```{r chart_cef_cost_main_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_main.R
#| out.width: "100%"
```

<!-- #### Actual unit cost incurred by the users (AUCU) (PI#1) -->

<!-- #### Regulatory result (RR) -->

```{r chart_cef_reg_res_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_aucu_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_aucu.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_ansp_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_ansp.R
#| out.width: "100%"
```

```{r chart_cef_net_res_main_ansp_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_net_res_main_ansp.R
#| out.width: "100%"
```

<!-- ### ECZ 2 -->
<!-- #### Unit cost (KPI#1) -->

```{r cz_def_ez2}
cztype <- "enroute"
czindex <- 2
no_cz <- params$no_ecz
```

```{r chart_cef_duc_l2_enroute2, options = (cz=c(czindex, cztype,"level2")), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_su_l2_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_su.R
#| out.width: "100%"
```



```{r chart_cef_cost_entity_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_entity.R
#| out.width: "100%"
```

```{r chart_cef_cost_main_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_main.R
#| out.width: "100%"
```

<!-- #### Actual unit cost incurred by the users (AUCU) (PI#1) -->

<!-- #### Regulatory result (RR) -->

```{r chart_cef_reg_res_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_aucu_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_aucu.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_ansp_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_ansp.R
#| out.width: "100%"
```

```{r chart_cef_net_res_main_ansp_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_net_res_main_ansp.R
#| out.width: "100%"
```

<!-- ### TCZ 1 -->
<!-- #### Unit cost (KPI#1) -->

```{r cz_def_tz1}
cztype <- "terminal"
czindex <- 1
no_cz <- params$no_tcz
```

```{r chart_cef_duc_l2_terminal1, options = (cz=c(czindex, cztype,"level2")), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_su_l2_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_su.R
#| out.width: "100%"
```

```{r chart_cef_cost_entity_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_entity.R
#| out.width: "100%"
```

```{r chart_cef_cost_main_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_main.R
#| out.width: "100%"
```

<!-- #### Actual unit cost incurred by the users (AUCU) (PI#1) -->

<!-- #### Regulatory result (RR) -->

```{r chart_cef_reg_res_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_aucu_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_aucu.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_ansp_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_ansp.R
#| out.width: "100%"
```

```{r chart_cef_net_res_main_ansp_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_net_res_main_ansp.R
#| out.width: "100%"
```

<!-- ### TCZ 2 -->
<!-- #### Unit cost (KPI#1) -->

```{r cz_def_tz2}
cztype <- "terminal"
czindex <- 2
no_cz <- params$no_tcz
```

```{r chart_cef_duc_l2_terminal2, options = (cz=c(czindex, cztype,"level2")), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level1_cef.R
#| out.width: "100%"
```

```{r chart_cef_su_l2_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_su.R
#| out.width: "100%"
```

```{r chart_cef_cost_entity_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_entity.R
#| out.width: "100%"
```

```{r chart_cef_cost_main_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost_main.R
#| out.width: "100%"
```

<!-- #### Actual unit cost incurred by the users (AUCU) (PI#1) -->

<!-- #### Regulatory result (RR) -->

```{r chart_cef_reg_res_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_aucu_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_aucu.R
#| out.width: "100%"
```

```{r chart_cef_reg_res_ansp_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_reg_res_ansp.R
#| out.width: "100%"
```

```{r chart_cef_net_res_main_ansp_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_net_res_main_ansp.R
#| out.width: "100%"
```

<!-- # End of charts and tables -->

<!-- Level2 text -->
```{r level_2_text}
source(here("R","get_level2_text.R"))
```

<!-- params -->
```{r fetch-data-state, eval=TRUE}
pp_version <- params$pp_version
acc_no <- params$acc_no
acc_list <- params$acc_list
acc1 <- params$acc1
acc2 <- params$acc2
acc3 <- params$acc3
acc4 <- params$acc4
acc5 <- params$acc5
no_apt_big <- params$no_apt_big
no_apt_small <- params$no_apt_small

nat_curr <- params$nat_curr
xrate2017 <- params$xrate2017
tsu_share <- params$tsu_share
ert_cost_share <- params$ert_cost_share
ert_trm_share <- params$ert_trm_share

main_ansp <- params$main_ansp
other_ansps_str <- params$other_ansps_str
other_met_str <- params$other_met_str

```

```{r yearly_xrates}
# get yearly xrates

xrate <- get_xrates("enroute", ecz_list$ecz_id[1]) |> 
  filter(year == year_report) |> 
  select(pp_exchangerate)

xrate_year_report <- if_else(country == "Luxembourg", 1, pull(xrate))

```


# OVERVIEW

## Contextual information
*`r pp_version`*

```{=latex}

\begin{figure}

\footnotesize

\begin{minipage}[t]{0.31\linewidth}
```

**List of ACCs     ** `r acc_no`  
\hspace*{2em} `r acc1` `r ifelse(acc2 != "", "  ", "")`
`r ifelse(acc2 != "", "\\hspace*{2em}", "")` `r acc2` `r ifelse(acc3 != "", "  ", "")`
`r ifelse(acc3 != "", "\\hspace*{2em}", "")` `r acc3` `r ifelse(acc4 != "", "  ", "")`
`r ifelse(acc4 != "", "\\hspace*{2em}", "")` `r acc4` `r ifelse(acc5 != "", "  ", "")`
`r ifelse(acc5 != "", "\\hspace*{2em}", "")` `r paste0(acc5, "  ")` 

\vspace*{1em}
**No of airports in the scope**  
**of the performance plan:**  
\hspace*{2em} • **≥80'K     ** `r no_apt_big`  
\hspace*{2em} • **<80'K     ** `r no_apt_small`

```{=latex}
\end{minipage}%
%
\begin{minipage}[t]{0.38\linewidth}
```

**Exchange rate (1 EUR=)**  
\hspace*{2em} `r paste0("2017: ", xrate2017, " ", nat_curr, "  ")` 
\hspace*{2em} `r paste0(year_report, ": ", xrate_year_report, " ", nat_curr, "  ")`

\vspace*{0.5em}**Share of Union-wide:**  
\hspace*{2em} • **traffic (TSUs) `r year_report`  **  `r paste0(tsu_share, "  ")` 
\hspace*{2em} • **en route costs `r year_report` ** `r paste0(ert_cost_share, "  ")` 
**Share en route / terminal**  
**costs `r year_report`                    ** `r paste0(ert_trm_share, "  ")` 

\vspace*{0.5em}**En route charging zone(s)**
```{r ecz_list_string}
ecz_list_string <- paste0(
  fixed('`\\hspace*{2em}`{=tex}'),
  ecz_list$ecz_name[1],
  if_else(is.na(ecz_list$ecz_name[2]), '' ,  paste0(fixed('` \\\\ \\hspace*{2em}`{=tex}'), ecz_list$ecz_name[2])
          )
)
```
`r paste0(ecz_list_string, "  ")` 

**Terminal charging zone(s)**  
```{r tcz_list_string}
tcz_list_string <- if_else(no_tcz == 0, '`\\hspace*{2em}`{=tex} --',
paste0(
  fixed('`\\hspace*{2em}`{=tex}'),
  tcz_list$tcz_name[1],
  if_else(is.na(tcz_list$tcz_name[2]), '' , paste0(fixed('`\\\\ \\hspace*{2em}`{=tex}'), tcz_list$tcz_name[2])
  )
  ))
```

`r tcz_list_string`

```{=latex}
\end{minipage}%
%
\begin{minipage}[t]{0.31\linewidth}
```

```{r ansp_list_strings}
# this is very convoluted but I couldnt find any other way
other_ansps_list <- str_split(other_ansps_str, "<br/>")[[1]] %>%
  discard(~ .x == "")

other_ansps_str_1 <- reduce(other_ansps_list, ~ paste(.x, .y, sep = fixed('`\\\\`{=tex}\\hspace*{1.2em}')))

other_met_list <- str_split(other_met_str, "<br/>")[[1]] %>%
  discard(~ .x == "")

other_met_str_1 <- reduce(other_met_list, ~ paste(.x, .y, sep = fixed('`\\\\`{=tex}\\hspace*{1.2em}')))

```


**Main ANSP**  
\hspace*{1em} • `r paste0(main_ansp, "  ")`  

\vspace*{1em}**Other ANSPs**
`\begin{flushleft}`{=tex}
\vspace*{-1em}\hspace*{1em} `r paste0(other_ansps_str_1, "  ")` 
`\end{flushleft}`{=tex}

**MET Providers**
`\begin{flushleft}`{=tex}
\vspace*{-1em}\hspace*{1em} `r other_met_str_1`
`\end{flushleft}`{=tex}

```{=latex}
\end{minipage}%

\end{figure}%
```


## Traffic (En route traffic zone)

```{r mvt_conc}
mvt_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "traffic_IFR", "Table_Findings_traffic_IFR")

mvt_text <- break_l1_text(mvt_conc1) 
mvt_text1 <- mvt_text$text1
mvt_text2 <- mvt_text$text2
```

```{r chart_level1_traffic_mvt}
#| file: R/chart_level1_traffic_mvt.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r mvt_conc1`

```{r su_conc1}
tsu_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "traffic_SUs", "Table_Findings_traffic_TSU")

tsu_text <- break_l1_text(tsu_conc1) 
tsu_text1 <- tsu_text$text1
tsu_text2 <- tsu_text$text2
```

```{r chart_level1_traffic_su}
#| file: R/chart_level1_traffic_su.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r tsu_conc1`

## Safety (Main ANSP)

```{r saf_conc1}
saf_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "safety", "Table_Findings_safety")
```

```{r chart_saf_l1, options = (saf_ansp_index = 1)}
#| file: R/chart_level1_saf.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r saf_conc1`

<!-- exception for luxembourg -->
`r if (params$country == "Luxembourg") "::: {.content-hidden}"`

## Environment (Member State)

```{r concl_env}
env_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "environment", "Table_Findings_environment")
```

```{r chart_env_kea_l1, options = (doclevel=c("level1"))}
#| file: R/chart_level1_kea.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r env_conc1`

`r if (params$country == "Luxembourg") ":::"`

## Capacity (Member State)

```{r concl_cap}
cap_er_conc1 <-  get_prb_conclusions("PRB_findings.xlsx", "ER_capacity", "Table_Findings_ER_capacity")
cap_trm_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "TRM_capacity", "Table_Findings_TRM_capacity")

cap_conc1 <- paste0(if_else(cap_er_conc1 == "character(0\n", "", paste0(cap_er_conc1, "\n\n")), if_else(cap_trm_conc1 == "NA" | stringr::str_detect(cap_trm_conc1, "character"), "", cap_trm_conc1))
```

```{r chart_cap_er, options = (cztype=c("enroute")), include = (params$country != "Luxembourg")}
#| file: R/chart_level1_cap.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r if_else(params$country != "Luxembourg", cap_er_conc1, '')`

```{r chart_cap_trm, options = (cztype=c("terminal")), include = params$no_tcz != 0}
#| file: R/chart_level1_cap.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r if_else(params$no_tcz != 0, cap_trm_conc1, '')`

## Cost-efficiency (En route/Terminal charging zone(s))

```{r concl-cef}
cef_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "cost-efficiency", "Table_Findings_CEFF")
```

```{r chart_cef_er_1, options = (cz=c("1", "enroute", "level1"))}
#| file: R/chart_level1_cef.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

```{r chart_cef_er_2, options = (cz=c("2", "enroute", "level1")), eval = (params$no_ecz == 2)}
#| file: R/chart_level1_cef.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

```{r chart_cef_trm_1, options = (cz=c("1", "terminal", "level1")), eval = (params$no_tcz != 0)}
#| file: R/chart_level1_cef.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

```{r chart_cef_trm_2, options = (cz=c("2", "terminal", "level1")), eval = (params$no_tcz == 2)}
#| file: R/chart_level1_cef.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r cef_conc1`

# SAFETY - `r toupper(params$country)`

## PRB monitoring

`r saf_conc1`

\needspace{2\baselineskip}

## Effectiveness of Safety Management (EoSM) (KPI#1)

`r if (params$no_saf_ansps >1) ":::: {.content-hidden}"`
```{=latex}
\begin{figure}[H]
\centering
\includegraphics[width=0.52\linewidth,height=\textheight,keepaspectratio]{index_files/figure-pdf/chart_level1_saf_1-1.pdf}
\end{figure}
```
`r if (params$no_saf_ansps >1) "::::"`


`r if (params$no_saf_ansps == 1) ":::: {.content-hidden}"`
`r layout_2fig("chart_level1_saf_1", if_else(params$no_saf_ansps == 1, "chart_level1_saf_1", "chart_level1_saf_2"))`
`r if (params$no_saf_ansps == 1) "::::"`


`r if (params$no_saf_ansps != 3) ":::: {.content-hidden}"`
```{=latex}
\begin{figure}[H]
\centering
\includegraphics[width=0.52\linewidth,height=\textheight,keepaspectratio]{index_files/figure-pdf/chart_level1_saf_3-1.pdf}
\end{figure}
```

`r if (params$no_saf_ansps != 3) "::::"`


`r if (params$no_saf_ansps != 4) ":::: {.content-hidden}"`
`r layout_2fig(if_else(params$no_saf_ansps < 3, "chart_level1_saf_1", "chart_level1_saf_3"), if_else(params$no_saf_ansps < 4, "chart_level1_saf_1", "chart_level1_saf_4"))`
`r if (params$no_saf_ansps != 4) "::::"`

\needspace{3\baselineskip}


\biggertext{Focus on EoSM}

`r latex_linebreaks(saf_eosm_text)`


`r if (params$country == "MUAC") "::: {.content-hidden}"`

\needspace{2\baselineskip}

## Safety occurrences

### Rate of runway incursions (RIs) (PI#1)

```{r table_level2_saf_ri_apt, eval= (params$country != "MUAC")}
#| file: R/table_level2_saf_ri_apt.R
#| include: false
```

``` {r, eval= (params$country != "MUAC")}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("Rate of RIs per 100,000 airport movements - ",  country),
  df = data_prep,
  col_align = "clrrr",
  col_widths = c(3, 27, 70/3, 70/3, 70/3)
))
```

`r if (params$country == "MUAC") ":::"`

\needspace{3\baselineskip}


\biggertext{Focus on runway incursions}

`r latex_linebreaks(saf_ri_text)`


\needspace{2\baselineskip}

### Rate of separation minima infringements (SMIs) (PI#2)

```{r table_level2_saf_smi_ansp_pdf1}
#| file: R/table_level2_saf_smi_ansp_pdf1.R
#| include: false
```


``` {r}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table_2level(
  title = paste0("Rate of SMI with ANS contribution per 100,000 flight hours"),
  df = data_prep,
  col_align = "llrrrrrrrrrr",
  col_widths = c(3,17,rep(8,10)),
  wrap_raw_block = FALSE,
  header_row_height_ex = 2.4,
  row_extrarowheight_pt = 2 
))
```

\vspace{-20pt}

```{r table_level2_saf_smi_ansp_pdf2}
#| file: R/table_level2_saf_smi_ansp_pdf2.R
#| include: false
```

``` {r}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table_2level(
  title = NA,
  df = data_prep,
  col_align = "llrrrrrrrrrr",
  col_widths = c(3,17,rep(8,10)),
  wrap_raw_block = FALSE,
  header_row_height_ex = 2.4,
  row_extrarowheight_pt = 2 
))
```

\needspace{3\baselineskip}


\biggertext{Focus on separation minima}

`r latex_linebreaks(saf_smi_text)`

\needspace{2\baselineskip}

### Quality of occurences reporting 

`r latex_linebreaks(saf_qr_text)`

\needspace{2\baselineskip}

## Use of automated safety data recording system (ASDRS) (PI#3)

```{r table_level2_saf_autotools}
#| file: R/table_level2_saf_autotools.R
#| include: false
```


``` {r}
#| echo: false
#| results: asis
cat(make_quarto_latex_table(
  title = paste0("Use of automated safety data recording system - ",  year_report),
  df = data_prep,
  col_labels = c("For RIs", "For SMIs"),
  col_align = "cc",
  checkmarks = TRUE

))
```

# ENVIRONMENT - `r toupper(params$country)`

## PRB monitoring

`r env_conc1`

`r if (params$country == "Luxembourg") "::: {.content-hidden}"`

\needspace{3\baselineskip}

## En route performance

### Horizontal flight efficiency of the actual trajectory (KEA) (KPI#1), of the last filed flight plan (KEP) (PI#1) & shortest constrained route (SCR) (PI#2)

`r layout_2fig("chart_env_kea_l2", "chart_env_kea_month")`

`r layout_2fig("chart_env_kep_scr", "chart_env_kep_scr_month")`

`r if (params$country == "Luxembourg") ":::"`


`r if (params$no_tcz == 0) "::: {.content-hidden}"`

\needspace{3\baselineskip}

## Terminal performance

### Additional taxi-out time (AXOT) (PI#3) & Arrival Sequencing and Metering Area (ASMA) time (PI#4)

```{r chart_axot_asma_country}
#| file: R/chart_level2_env_axot_asma_country.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r layout_2fig("chart_axot_apt", "chart_asma_apt")`

\needspace{3\baselineskip}

`\biggertext{Focus on ASMA \& AXOT}`{=latex}

**AXOT**

`r if (exists("env_apt_2") == FALSE) {''} else {latex_linebreaks(env_apt_2)}`

\needspace{2\baselineskip}

**ASMA**

`r if (exists("env_apt_3") == FALSE) {''} else {latex_linebreaks(env_apt_3)}`

### Share of arrivals applying continuous descent operations (CDOs) (PI#5)

`r layout_2fig("chart_cdo_country", "chart_cdo_apt")`


\needspace{2\baselineskip}

`\biggertext{Focus CDOs}`{=latex}

`r if (exists("env_apt_4") == FALSE) {''} else {latex_linebreaks(env_apt_4)}`


```{r table_level2_env_apt_pis, eval=(params$no_tcz != 0)}
#| file: R/table_level2_env_apt_pis.R
#| include: false
```


``` {r, eval=(params$no_tcz != 0), include=(params$no_tcz != 0)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table_2level(
  title = paste0("Airport level"),
  df = data_prep_pdf,    
  caption_fontsize = c(10, 10),
  body_fontsize = c(7, 8.4),
  col_align = "lrrrrrrrrrrrrrrr",
  col_widths = c(10,rep(90/15,15)),
  wrap_raw_block = FALSE,
  header_row_height_ex = 2.4,
  row_extrarowheight_pt = 2 
))
```

`r if (params$no_tcz == 0) ":::"`


`r if (params$country == "Luxembourg") "::: {.content-hidden}"`

## Civil-Military dimension

```{r chart_ersa}
#| file: R/chart_level2_env_ersa.R
#| out.width: "60%"
#| fig.align: "center"
#| fig-pos: "H"
```

`r layout_2fig("chart_cdr", "chart_rsa")`

\needspace{3\baselineskip}

`\biggertext{Focus on Civil-Military dimension}`{=latex}

**Update on Military dimension of the plan**

`r latex_linebreaks(env_mil_1)`


`r if (params$year_report != 2020) ":::: {.content-hidden}"`

\needspace{2\baselineskip}

**Military - related measures implemented or planned to improve environment and capacity**

`r if (params$year_report != 2020) "::::"`

`r if (params$year_report == 2020) ":::: {.content-hidden}"`

\needspace{2\baselineskip}

**Military - related measures implemented or planned to improve capacity**

`r if (params$year_report == 2020) "::::"`

`r latex_linebreaks(env_mil_2)`

\needspace{2\baselineskip}

**Initiatives implemented or planned to improve PI#6**

`r latex_linebreaks(env_mil_4)`

\needspace{2\baselineskip}

**Initiatives implemented or planned to improve PI#7**

`r latex_linebreaks(env_mil_6)`

\needspace{2\baselineskip}

**Initiatives implemented or planned to improve PI#8**

`r latex_linebreaks(env_mil_8)`

`r if (params$country == "Luxembourg") ":::"`

# CAPACITY - `r toupper(params$country)`

## PRB monitoring

```{r cap-prb}
if (params$country == "Luxembourg") {
  cap_er_conc1 <- ""
  } else {
  cap_er_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "ER_capacity", "Table_Findings_ER_capacity")
}
```

`r cap_er_conc1`

`r if (params$no_tcz == 0 | params$year_report <= 2023) "::: {.content-hidden}"`

```{r cap-trm-prb}
cap_trm_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "TRM_capacity", "Table_Findings_TRM_capacity")

cap_trm_conc1 <- if_else(cap_trm_conc1 == "NA" | stringr::str_detect(cap_trm_conc1, "character"), "", cap_trm_conc1)
```

`r cap_trm_conc1`

`r if (params$no_tcz == 0 | params$year_report <= 2023) ":::"`



`r if (params$country == "Luxembourg") "::: {.content-hidden}"`

\needspace{3\baselineskip}

## En route performance

### En route ATFM delay (KPI#1)

`r layout_2fig("chart_cap_er_l2", "chart_cap_er_month")`

```{r chart_cap_delay_bin}
#| file: R/chart_level2_cap_delay_bin.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

\needspace{3\baselineskip}

`\biggertext{Focus on en route ATFM delay}`{=latex}

**Summary of capacity performance**

`r if_else(length(cap_heading_ukraine) == 0, latex_linebreaks(cap_er_nsa_7), latex_linebreaks(cap_er_nsa_8))`

\needspace{2\baselineskip}

**NSA's assessment of capacity performance**

`r latex_linebreaks(cap_er_nsa_2)`

\needspace{2\baselineskip}

**Monitoring process for capacity performance**

`r latex_linebreaks(cap_er_nsa_3)`

\needspace{2\baselineskip}

**Capacity planning**

`r latex_linebreaks(cap_er_nsa_4)`

\needspace{2\baselineskip}

**Application of Corrective Measures for Capacity (if applicable)**

`r latex_linebreaks(cap_er_nsa_6)`

`r if_else(length(cap_heading_ukraine) == 0, "", paste0("**Additional Information Related to Russia's War of Aggression Against Ukraine**<br><br>", latex_linebreaks(cap_er_nsa_7)))`

`r if (params$year_report <= 2022) "::::: {.content-hidden}"`

\needspace{2\baselineskip}

**En route Capacity Incentive Scheme**														

`r latex_linebreaks(cap_er_nsa_incentive)`

`r if (params$year_report <= 2022) ":::::"`


### Other indicators

`r layout_2fig("chart_cap_atco", "chart_cap_atco_acc")`

```{r chart_cap_sector_opening}
#| file: R/chart_level2_cap_sector_opening.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```


`\biggertext{Focus on ATCOs in operations}`{=latex}

`r latex_linebreaks(cap_er_nsa_5)`


`r if (params$country == "Luxembourg") ":::"`


`r if (params$no_tcz == 0) "::: {.content-hidden}"`


\needspace{3\baselineskip}

## Terminal performance

### Arrival ATFM delay (KPI#2)

`r layout_2fig("chart_cap_trm_l2", "chart_cap_trm_month")`

\needspace{3\baselineskip}

`\biggertext{Focus on arrival ATFM delay}`{=latex}

`r if (exists("cap_trm_nsa_1") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_1)}`

`r if (exists("cap_trm_nsa_2") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_2)}`

`r if (exists("cap_trm_nsa_3") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_3)}`


### Other terminal performance indicators (PI#1-3)

```{r chart_cap_all_causes_delay}
#| file: R/chart_level2_cap_all_causes_delay.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```

```{r table_level2_cap_apt_pis_pdf1, eval=(params$no_tcz != 0)}
#| file: R/table_level2_cap_apt_pis_pdf1.R
#| include: false
```


``` {r eval=(params$no_tcz != 0), include=(params$no_tcz != 0)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table_2level(
  title = paste0("Airport level"),
  df = data_prep,
  col_align = "lrrrrrrrrrr",
  col_widths = c(20,rep(8,10)),
  wrap_raw_block = FALSE,
  header_row_height_ex = 2.4,
  row_extrarowheight_pt = 2 
))
```

\vspace{-20pt}

```{r table_level2_cap_apt_pis_pdf2, eval=(params$no_tcz != 0)}
#| file: R/table_level2_cap_apt_pis_pdf2.R
#| include: false
```


``` {r eval=(params$no_tcz != 0), include=(params$no_tcz != 0)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table_2level(
  title = NA,
  df = data_prep,
  col_align = "lrrrrrrrrrr",
  col_widths = c(20,rep(8,10)),
  wrap_raw_block = FALSE,
  header_row_height_ex = 2.4,
  row_extrarowheight_pt = 2 
))
```


\needspace{3\baselineskip}

`\biggertext{Focus on performance indicators at airport level}`{=latex}

**ATFM slot adherence**

`r if (exists("cap_trm_nsa_4") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_4)}`


\needspace{2\baselineskip}

**ATC pre-departure delay**

`r if (exists("cap_trm_nsa_5") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_5)}`

\needspace{2\baselineskip}

**All causes pre-departure delay**

`r if (exists("cap_trm_nsa_6") == FALSE) {''} else {latex_linebreaks(cap_trm_nsa_6)}`

`r if (params$no_tcz == 0) ":::"`

# COST-EFFICIENCY - `r toupper(params$country)`

## PRB monitoring

```{r concl_cef_duc_e1}
cef_conc1 <- get_prb_conclusions("PRB_findings.xlsx", "cost-efficiency", "Table_Findings_CEFF")
```

`r cef_conc1`


::: {.content-hidden}
## ECZ 1
:::

```{r cef_level2_setup_ecz1}
cztype <- "enroute"
czindex <- 1
cztype_proper <- "En route"
no_cz <- params$no_ecz

if (czindex > no_ecz) {
# do nothing

} else {

czname <- ecz_list$ecz_name[[czindex]]
cef_level2_text <- get_cef_level2_text(czindex, cztype)
}
```

\needspace{3\baselineskip}

`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone - `r czname`
`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) ":::"`


`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone 
`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) ":::"`

### Unit cost (KPI#1)

`r layout_2fig(paste0("chart_cef_duc_l2_", cztype, czindex), paste0("chart_cef_su_l2_", cztype, czindex))`


```{r chart_cef_cost_enroute1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost.R
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cost_enroute1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("Actual and determined data"),
  col_labels = c("Total costs - nominal (M€)", "2020‑2021", '2022', '2023', '2024'),
  df = data_prep_pdf,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

\vspace{-20pt}

```{r table_level2_cef_cost_infl_enroute1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost_infl.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

`r layout_2fig(paste0("chart_cef_cost_entity_", cztype, czindex), paste0("chart_cef_cost_main_", cztype, czindex))`


\needspace{3\baselineskip}

`\biggertext{Focus on unit cost}`{=latex}

**AUC vs. DUC**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[2,1]) == TRUE, cef_level2_text$cef_txt_1_4_duc, pull(cef_level2_text$cef_txt_1_4[2,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` service units**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]) == TRUE, cef_level2_text$cef_txt_1_4_su, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs by entity**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]) == TRUE, cef_level2_text$cef_txt_1_4_cost_all, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs for the main ANSP at charging zone level**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1]) == TRUE, latex_linebreaks(cef_level2_text$cef_txt_1_4_cost_main), latex_linebreaks(pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1])))`

### Actual unit cost incurred by the users (AUCU) (PI#1)

```{r chart_cef_aucu_enroute1, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = (no_cz >= czindex)}
#| file: R/chart_level2_cef_aucu.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_aucu_enroute1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_aucu.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("AUCU components (€/SU) – ",
                      if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
  df = data_prep_pdf,
  col_labels = c(paste0("Components of the AUCU in ", 
                           if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))), 
             "€/SU"
             ),
  col_align = "lr",
  col_widths = c(80, 20)
))
```


```{r chart_cef_cex_enroute1, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cex.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cex_enroute1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cex.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep_pdf,
  col_labels = c(paste0("Cost exempt from cost sharing by item - ", 
                             if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
                         "€'000",
                        "€/SU"
  ),
  col_align = "lrr",
  col_widths = c(60, 20, 20)
))
```

### Regulatory result (RR)

`r layout_2fig(paste0("chart_cef_reg_res_", cztype, czindex), paste0("chart_cef_reg_res_aucu_", cztype, czindex))`

`r layout_2fig(paste0("chart_cef_reg_res_ansp_", cztype, czindex), paste0("chart_cef_net_res_main_ansp_", cztype, czindex))`


`\biggertext{Focus on regulatory result}`{=latex}

`r if (params$year_report < 2022) "::: {.content-hidden}"`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[1,1]`**

`r cef_level2_text$cef_txt_1_13[2,1]`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[3,1]`**

`r cef_level2_text$cef_txt_1_13[4,1]`

`r cef_level2_text$cef_txt_1_10_txt`

`r if (params$year_report < 2022) ":::"`

`r if (params$year_report >= 2022) "::: {.content-hidden}"`

`r latex_linebreaks(cef_level2_text$cef_txt_1_13[1,1])`

`r latex_linebreaks(cef_level2_text$cef_txt_1_10_txt)`

`r if (params$year_report >= 2022) ":::"`


`r if (params$no_ecz < 2) "::: {.content-hidden}"`

::: {.content-hidden}
## ECZ 2
:::

```{r cef_level2_setup_ecz2}
cztype <- "enroute"
czindex <- 2
cztype_proper <- "En route"
no_cz <- params$no_ecz

if (czindex > no_ecz) {
# do nothing

} else {

czname <- ecz_list$ecz_name[[czindex]]
cef_level2_text <- get_cef_level2_text(czindex, cztype)
}
```

\needspace{3\baselineskip}

`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone - `r czname`
`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) ":::"`


`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone 
`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) ":::"`

### Unit cost (KPI#1)

`r layout_2fig(paste0("chart_cef_duc_l2_", cztype, czindex), paste0("chart_cef_su_l2_", cztype, czindex))`


```{r chart_cef_cost_enroute2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost.R
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cost_enroute2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("Actual and determined data"),
  df = data_prep_pdf,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

\vspace{-20pt}

```{r table_level2_cef_cost_infl_enroute2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost_infl.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

`r layout_2fig(paste0("chart_cef_cost_entity_", cztype, czindex), paste0("chart_cef_cost_main_", cztype, czindex))`


\needspace{3\baselineskip}

`\biggertext{Focus on unit cost}`{=latex}

**AUC vs. DUC**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[2,1]) == TRUE, cef_level2_text$cef_txt_1_4_duc, pull(cef_level2_text$cef_txt_1_4[2,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` service units**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]) == TRUE, cef_level2_text$cef_txt_1_4_su, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs by entity**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]) == TRUE, cef_level2_text$cef_txt_1_4_cost_all, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs for the main ANSP at charging zone level**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1]) == TRUE, latex_linebreaks(cef_level2_text$cef_txt_1_4_cost_main), latex_linebreaks(pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1])))`

### Actual unit cost incurred by the users (AUCU) (PI#1)

```{r chart_cef_aucu_enroute2, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = (no_cz >= czindex)}
#| file: R/chart_level2_cef_aucu.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_aucu_enroute2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_aucu.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("AUCU components (€/SU) – ",
                      if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
  df = data_prep_pdf,
  col_labels = c(paste0("Components of the AUCU in ", 
                           if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))), 
             "€/SU"
             ),
  col_align = "lr",
  col_widths = c(80, 20)
))
```


```{r chart_cef_cex_enroute2, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cex.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cex_enroute2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cex.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep_pdf,
  col_labels = c(paste0("Cost exempt from cost sharing by item - ", 
                             if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
                         "€'000",
                        "€/SU"
  ),
  col_align = "lrr",
  col_widths = c(60, 20, 20)
))
```

### Regulatory result (RR)

`r layout_2fig(paste0("chart_cef_reg_res_", cztype, czindex), paste0("chart_cef_reg_res_aucu_", cztype, czindex))`

`r layout_2fig(paste0("chart_cef_reg_res_ansp_", cztype, czindex), paste0("chart_cef_net_res_main_ansp_", cztype, czindex))`


`\biggertext{Focus on regulatory result}`{=latex}

`r if (params$year_report < 2022) "::: {.content-hidden}"`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[1,1]`**

`r cef_level2_text$cef_txt_1_13[2,1]`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[3,1]`**

`r cef_level2_text$cef_txt_1_13[4,1]`

`r cef_level2_text$cef_txt_1_10_txt`

`r if (params$year_report < 2022) ":::"`

`r if (params$year_report >= 2022) "::: {.content-hidden}"`

`r latex_linebreaks(cef_level2_text$cef_txt_1_13[1,1])`

`r latex_linebreaks(cef_level2_text$cef_txt_1_10_txt)`

`r if (params$year_report >= 2022) ":::"`

`r if (params$no_ecz < 2) ":::"`

`r if (params$no_tcz == 0) "::: {.content-hidden}"`

::: {.content-hidden}
## TCZ 1
:::

```{r cef_level2_setup_tcz1}
cztype <- "terminal"
czindex <- 1
cztype_proper <- "Terminal"
no_cz <- params$no_tcz

if (czindex > no_tcz) {
# do nothing

} else {

czname <- tcz_list$tcz_name[[czindex]]
cef_level2_text <- get_cef_level2_text(czindex, cztype)
}

```

\needspace{3\baselineskip}

`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone - `r czname`
`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) ":::"`


`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone 
`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) ":::"`

### Unit cost (KPI#1)

`r layout_2fig(paste0("chart_cef_duc_l2_", cztype, czindex), paste0("chart_cef_su_l2_", cztype, czindex))`


```{r chart_cef_cost_terminal1, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost.R
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cost_terminal1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("Actual and determined data"),
  col_labels = c("Total costs - nominal (M€)", "2020‑2021", '2022', '2023', '2024'),
  df = data_prep_pdf,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

\vspace{-20pt}

```{r table_level2_cef_cost_infl_terminal1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost_infl.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

`r layout_2fig(paste0("chart_cef_cost_entity_", cztype, czindex), paste0("chart_cef_cost_main_", cztype, czindex))`


\needspace{3\baselineskip}

`\biggertext{Focus on unit cost}`{=latex}

**AUC vs. DUC**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[2,1]) == TRUE, cef_level2_text$cef_txt_1_4_duc, pull(cef_level2_text$cef_txt_1_4[2,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` service units**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]) == TRUE, cef_level2_text$cef_txt_1_4_su, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs by entity**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]) == TRUE, cef_level2_text$cef_txt_1_4_cost_all, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs for the main ANSP at charging zone level**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1]) == TRUE, latex_linebreaks(cef_level2_text$cef_txt_1_4_cost_main), latex_linebreaks(pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1])))`

### Actual unit cost incurred by the users (AUCU) (PI#1)

```{r chart_cef_aucu_terminal1, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = (no_cz >= czindex)}
#| file: R/chart_level2_cef_aucu.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_aucu_terminal1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_aucu.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("AUCU components (€/SU) – ",
                      if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
  df = data_prep_pdf,
  col_labels = c(paste0("Components of the AUCU in ", 
                           if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))), 
             "€/SU"
             ),
  col_align = "lr",
  col_widths = c(80, 20)
))
```


```{r chart_cef_cex_terminal1, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cex.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cex_terminal1, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cex.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep_pdf,
  col_labels = c(paste0("Cost exempt from cost sharing by item - ", 
                             if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
                         "€'000",
                        "€/SU"
  ),
  col_align = "lrr",
  col_widths = c(60, 20, 20)
))
```

### Regulatory result (RR)

`r layout_2fig(paste0("chart_cef_reg_res_", cztype, czindex), paste0("chart_cef_reg_res_aucu_", cztype, czindex))`

`r layout_2fig(paste0("chart_cef_reg_res_ansp_", cztype, czindex), paste0("chart_cef_net_res_main_ansp_", cztype, czindex))`


`\biggertext{Focus on regulatory result}`{=latex}

`r if (params$year_report < 2022) "::: {.content-hidden}"`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[1,1]`**

`r cef_level2_text$cef_txt_1_13[2,1]`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[3,1]`**

`r cef_level2_text$cef_txt_1_13[4,1]`

`r cef_level2_text$cef_txt_1_10_txt`

`r if (params$year_report < 2022) ":::"`

`r if (params$year_report >= 2022) "::: {.content-hidden}"`

`r latex_linebreaks(cef_level2_text$cef_txt_1_13[1,1])`

`r latex_linebreaks(cef_level2_text$cef_txt_1_10_txt)`

`r if (params$year_report >= 2022) ":::"`


`r if (params$no_tcz < 2) "::: {.content-hidden}"`

::: {.content-hidden}
## TCZ 2
:::

```{r cef_level2_setup_tcz2}
cztype <- "terminal"
czindex <- 2
cztype_proper <- "Terminal"
no_cz <- params$no_tcz

if (czindex > no_tcz) {
# do nothing

} else {

czname <- tcz_list$tcz_name[[czindex]]
cef_level2_text <- get_cef_level2_text(czindex, cztype)
}

```

\needspace{3\baselineskip}

`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone - `r czname`
`r if ((params$no_ecz == 1 & cztype == 'enroute') | (params$no_tcz == 1 & cztype == 'terminal')) ":::"`


`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) "::: {.content-hidden}"`
## `r cztype_proper` charging zone
`r if ((params$no_ecz > 1 & cztype == 'enroute') | (params$no_tcz > 1 & cztype == 'terminal')) ":::"`

### Unit cost (KPI#1)

`r layout_2fig(paste0("chart_cef_duc_l2_", cztype, czindex), paste0("chart_cef_su_l2_", cztype, czindex))`


```{r chart_cef_cost_terminal2, options = (cz=c(czindex, cztype)), include=FALSE, eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cost.R
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cost_terminal2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("Actual and determined data"),
  col_labels = c("Total costs - nominal (M€)", "2020‑2021", '2022', '2023', '2024'),
  df = data_prep_pdf,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

\vspace{-20pt}

```{r table_level2_cef_cost_infl_terminal2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cost_infl.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep,
  col_align = "lrrrr",
  col_widths = c(35, rep(65/4, 4))
))
```

`r layout_2fig(paste0("chart_cef_cost_entity_", cztype, czindex), paste0("chart_cef_cost_main_", cztype, czindex))`


\needspace{3\baselineskip}

`\biggertext{Focus on unit cost}`{=latex}

**AUC vs. DUC**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[2,1]) == TRUE, cef_level2_text$cef_txt_1_4_duc, pull(cef_level2_text$cef_txt_1_4[2,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` service units**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]) == TRUE, cef_level2_text$cef_txt_1_4_su, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_su,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs by entity**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]) == TRUE, cef_level2_text$cef_txt_1_4_cost_all, pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_by_ent,1]))`

\needspace{2\baselineskip}

**`r cztype_proper` costs for the main ANSP at charging zone level**

`r if_else(is.na(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1]) == TRUE, latex_linebreaks(cef_level2_text$cef_txt_1_4_cost_main), latex_linebreaks(pull(cef_level2_text$cef_txt_1_4[cef_level2_text$my_index_cost_main,1])))`

### Actual unit cost incurred by the users (AUCU) (PI#1)

```{r chart_cef_aucu_terminal2, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = (no_cz >= czindex)}
#| file: R/chart_level2_cef_aucu.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_aucu_terminal2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_aucu.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = paste0("AUCU components (€/SU) – ",
                      if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
  df = data_prep_pdf,
  col_labels = c(paste0("Components of the AUCU in ", 
                           if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))), 
             "€/SU"
             ),
  col_align = "lr",
  col_widths = c(80, 20)
))
```


```{r chart_cef_cex_terminal2, options = (cz=c(czindex, cztype)), include=(no_cz >= czindex), eval = no_cz >= czindex}
#| file: R/chart_level2_cef_cex.R
#| out.width: "52%"
#| fig.align: "center"
#| fig-pos: "H"
```  


```{r table_level2_cef_cex_terminal2, options = (cz=c(czindex, cztype)), eval = (no_cz >= czindex)}
#| file: R/table_level2_cef_cex.R
#| include: false
```

``` {r, eval = (no_cz >= czindex), include = (no_cz >= czindex)}
#| echo: false
#| results: asis
 
cat(make_quarto_latex_table(
  title = NA,
  df = data_prep_pdf,
  col_labels = c(paste0("Cost exempt from cost sharing by item - ", 
                             if_else(year_report == 2021 | year_report == 2020, "2020-2021", as.character(year_report))),
                         "€'000",
                        "€/SU"
  ),
  col_align = "lrr",
  col_widths = c(60, 20, 20)
))
```

### Regulatory result (RR)

`r layout_2fig(paste0("chart_cef_reg_res_", cztype, czindex), paste0("chart_cef_reg_res_aucu_", cztype, czindex))`

`r layout_2fig(paste0("chart_cef_reg_res_ansp_", cztype, czindex), paste0("chart_cef_net_res_main_ansp_", cztype, czindex))`


`\biggertext{Focus on regulatory result}`{=latex}

`r if (params$year_report < 2022) "::: {.content-hidden}"`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[1,1]`**

`r cef_level2_text$cef_txt_1_13[2,1]`

\needspace{2\baselineskip}

**`r cef_level2_text$cef_txt_1_13[3,1]`**

`r cef_level2_text$cef_txt_1_13[4,1]`

`r cef_level2_text$cef_txt_1_10_txt`

`r if (params$year_report < 2022) ":::"`

`r if (params$year_report >= 2022) "::: {.content-hidden}"`

`r latex_linebreaks(cef_level2_text$cef_txt_1_13[1,1])`

`r latex_linebreaks(cef_level2_text$cef_txt_1_10_txt)`

`r if (params$year_report >= 2022) ":::"`

`r if (params$no_tcz < 2) ":::"`

`r if (params$no_tcz == 0) ":::"`
